<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flower DNA</title>
    <style>
        /* 1. ФОН ЗАДАЄМО ЧЕРЕЗ CSS (Гарантія, що не буде чорного екрану) */
        body { 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-family: monospace;
        }
        
        canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            mix-blend-mode: screen; /* Легке накладання */
        }

        #ui { 
            position: relative; 
            z-index: 100; 
            text-align: center; 
            width: 100%; 
            pointer-events: none;
        }

        #startBtn { 
            pointer-events: auto; 
            padding: 15px 35px; 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            color: #fff; 
            border-radius: 50px; 
            cursor: pointer; 
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
            transition: 0.3s;
        }

        /* Блок для виведення помилок, якщо вони будуть */
        #debug {
            position: absolute;
            top: 0;
            left: 0;
            color: red;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            font-size: 12px;
            z-index: 999;
            display: none; 
        }
    </style>
</head>
<body>

    <div id="debug"></div>

    <div id="ui">
        <button id="startBtn">START JOURNEY</button>
    </div>
    
    <canvas id="canvas"></canvas>

    <script>
        // Глобальний перехоплювач помилок (щоб ми бачили, що не так)
        window.onerror = function(msg, url, line) {
            const d = document.getElementById('debug');
            d.style.display = 'block';
            d.innerHTML += `Error: ${msg}<br>Line: ${line}<br>`;
            return false;
        };

        try {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const btn = document.getElementById('startBtn');
            
            // 1. Очищення параметрів (Захист від null)
            const params = new URLSearchParams(window.location.search);
            const hue = parseInt(params.get('hue')) || 280;
            const petals = parseInt(params.get('petals')) || 8;
            const freq = parseInt(params.get('freq')) || 432;
            const element = (params.get('element') || "water").toLowerCase();

            // 2. Налаштування (Без складних об'єктів)
            let speed = 0.02;
            let themeHue = 220;
            
            if(element.includes("fire")) { speed = 0.04; themeHue = 10; }
            else if(element.includes("earth")) { speed = 0.01; themeHue = 120; }
            else if(element.includes("air")) { speed = 0.05; themeHue = 190; }

            // Оновлюємо фон CSS під стихію
            document.body.style.background = `radial-gradient(circle at center, hsla(${themeHue}, 60%, 15%, 1) 0%, #000000 100%)`;

            let w, h;
            const stars = [];

            function resize() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
                // Перестворюємо зірки при зміні розміру
                stars.length = 0;
                for(let i=0; i<100; i++) {
                    stars.push({
                        x: Math.random() * w,
                        y: Math.random() * h,
                        size: Math.random() * 2 + 0.5,
                        speed: Math.random() * 0.5 + 0.1
                    });
                }
            }
            window.addEventListener('resize', resize);
            resize();

            let t = 0;

            function draw() {
                // Очищаємо екран (просто прозорість, бо фон у нас в CSS)
                ctx.clearRect(0, 0, w, h);

                // 1. ЗІРКИ
                ctx.fillStyle = "white";
                ctx.shadowBlur = 0; // Вимикаємо світіння для зірок для продуктивності
                
                stars.forEach(s => {
                    ctx.globalAlpha = 0.5 + Math.sin(t * 2 + s.x) * 0.3;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Рух
                    s.y -= s.speed;
                    if(s.y < 0) { s.y = h; s.x = Math.random() * w; }
                });

                // 2. КВІТКА
                ctx.save();
                ctx.translate(w / 2, h / 2);
                
                // Легке дихання
                const scaleOsc = 1 + Math.sin(t * 0.5) * 0.05;
                ctx.scale(scaleOsc, scaleOsc);
                ctx.rotate(t * 0.1);

                // Сяйво квітки
                ctx.shadowBlur = 20;
                ctx.shadowColor = `hsla(${hue}, 100%, 50%, 0.8)`;
                ctx.globalCompositeOperation = 'source-over'; // Стандартний режим

                // Малюємо кілька шарів
                for(let layer = 0; layer < 3; layer++) {
                    const layerSize = 1 - (layer * 0.2);
                    const alpha = 1 - (layer * 0.2);
                    
                    for(let i = 0; i < petals; i++) {
                        ctx.save();
                        const angle = (Math.PI * 2 / petals) * i + (layer * 0.1);
                        ctx.rotate(angle);

                        ctx.strokeStyle = `hsla(${hue + layer*10}, 100%, 70%, ${alpha})`;
                        ctx.lineWidth = 2;

                        const len = 150 * layerSize;
                        const wid = 50 * layerSize;

                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.quadraticCurveTo(wid, len / 2, 0, len);
                        ctx.quadraticCurveTo(-wid, len / 2, 0, 0);
                        ctx.stroke();
                        
                        // Жилка
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(0, len * 0.8);
                        ctx.stroke();

                        ctx.restore();
                    }
                }

                ctx.restore();

                t += speed;
                requestAnimationFrame(draw);
            }

            // Запуск анімації одразу
            draw();

            // Обробка кнопки
            btn.addEventListener('click', () => {
                btn.style.opacity = 0;
                setTimeout(() => btn.remove(), 500);

                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        const ac = new AudioContext();
                        const osc = ac.createOscillator();
                        const gn = ac.createGain();
                        osc.frequency.value = freq;
                        gn.gain.setValueAtTime(0, ac.currentTime);
                        gn.gain.linearRampToValueAtTime(0.1, ac.currentTime + 1);
                        osc.connect(gn);
                        gn.connect(ac.destination);
                        osc.start();
                    }
                } catch(e) {
                    console.log("Audio error: " + e);
                }
            });

        } catch (criticalError) {
            document.getElementById('debug').style.display = 'block';
            document.getElementById('debug').innerText = "CRITICAL: " + criticalError.message;
        }
    </script>
</body>
</html>
