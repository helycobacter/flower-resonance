<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #000; overflow: hidden; height: 100vh; display: flex; align-items: center; justify-content: center; }
        canvas { position: absolute; top: 0; left: 0; }
        #ui { position: absolute; z-index: 10; bottom: 30px; text-align: center; width: 100%; pointer-events: none; }
        #startBtn { pointer-events: auto; padding: 12px 30px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 30px; cursor: pointer; backdrop-filter: blur(5px); font-family: sans-serif; letter-spacing: 1px; transition: 0.3s; }
        #startBtn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.5); }
    </style>
</head>
<body>
    <div id="ui"><button id="startBtn">ACTIVATE RESONANCE</button></div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const params = new URLSearchParams(window.location.search);
        
        const hue = parseInt(params.get('hue')) || 280;
        const petals = parseInt(params.get('petals')) || 8;
        const freq = parseInt(params.get('freq')) || 432;
        const element = (params.get('element') || "water").toLowerCase();

        const styles = {
            fire:  { h: 10,  s: 100, l: 30, speed: 0.035 },
            earth: { h: 125, s: 50,  l: 20, speed: 0.012 },
            air:   { h: 195, s: 70,  l: 50, speed: 0.045 },
            water: { h: 225, s: 60,  l: 35, speed: 0.018 }
        };
        const stl = styles[element] || styles.water;

        let w, h;
        const stars = [];
        
        function init() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            stars.length = 0;
            for(let i=0; i<120; i++) {
                stars.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    size: Math.random() * 1.8,
                    speed: 0.2 + Math.random() * 0.5
                });
            }
        }
        window.addEventListener('resize', init);
        init();

        let t = 0;

        function drawPetal(len, width, angle, color, alpha) {
            ctx.save();
            ctx.rotate(angle);
            ctx.globalAlpha = alpha;
            
            // Сяйво пелюстки
            ctx.shadowBlur = 20;
            ctx.shadowColor = color;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 2.5;
            
            ctx.beginPath();
            ctx.moveTo(0, 0);
            // Витончена форма лотоса
            ctx.bezierCurveTo(width, len/3, width, len*2/3, 0, len);
            ctx.bezierCurveTo(-width, len*2/3, -width, len/3, 0, 0);
            ctx.stroke();

            // Внутрішня лінія
            ctx.beginPath();
            ctx.lineWidth = 1;
            ctx.moveTo(0, 10);
            ctx.lineTo(0, len * 0.7);
            ctx.stroke();
            
            ctx.restore();
        }

        function draw() {
            // 1. Глибокий фон
            const grd = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w*0.8);
            grd.addColorStop(0, `hsla(${stl.h}, ${stl.s}%, 8%, 1)`);
            grd.addColorStop(1, "#000");
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, w, h);

            // 2. Зірки (малюємо перед квіткою)
            ctx.fillStyle = "#fff";
            stars.forEach(s => {
                const flicker = 0.4 + Math.abs(Math.sin(t * s.speed)) * 0.6;
                ctx.globalAlpha = flicker;
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            ctx.save();
            ctx.translate(w/2, h/2);
            
            // Динаміка квітки
            ctx.rotate(t * 0.08);
            const driftX = Math.cos(t * 0.4) * 8;
            const driftY = Math.sin(t * 0.4) * 8;
            ctx.translate(driftX, driftY);

            // Малюємо 3 шари пелюсток
            for (let layer = 2; layer >= 0; layer--) {
                const scale = 1 - layer * 0.25;
                const alpha = 0.9 - layer * 0.25;
                const currentLen = (190 + Math.sin(t + layer) * 25) * scale;
                const currentWidth = 65 * scale;

                for (let i = 0; i < petals; i++) {
                    const angle = (Math.PI * 2 / petals) * i + (layer * 0.3 * Math.sin(t*0.2));
                    const pColor = `hsla(${hue + (layer * 20)}, 100%, 75%, 1)`;
                    drawPetal(currentLen, currentWidth, angle, pColor, alpha);
                }
            }

            ctx.restore();

            t += stl.speed;
            requestAnimationFrame(draw);
        }

        document.getElementById('startBtn').onclick = (e) => {
            e.target.style.display = 'none';
            try {
                const ac = new (window.AudioContext || window.webkitAudioContext)();
                const o = ac.createOscillator();
                const g = ac.createGain();
                o.frequency.value = freq;
                g.gain.setValueAtTime(0, ac.currentTime);
                g.gain.linearRampToValueAtTime(0.12, ac.currentTime + 2);
                o.connect(g); g.connect(ac.destination);
                o.start();
            } catch(err) {}
        };

        draw();
    </script>
</body>
</html>
